#!/usr/bin/python3
#
# Helper script for creating test result & log data then push it to git
#
import os
import sys

scripts_path = os.path.dirname(os.path.realpath(__file__))
lib_path = scripts_path + '/lib'
sys.path = sys.path + [lib_path]
#from testresultlog.testmatrixcreator import TestEnvMatrixCreator
from testresultlog.testplancreator import TestPlanCreator
from testresultlog.testplangitwriter import TestPlanGitWriter
from testresultlog.testresultlogconfigparser import TestResultLogConfigParser

def main():

    testplan_conf = os.path.join(scripts_path, 'lib/testresultlog/conf/testplan.conf')
    component_conf = os.path.join(scripts_path, 'lib/testresultlog/conf/testplan_component.conf')
    environment_conf = os.path.join(scripts_path, 'lib/testresultlog/conf/testplan_component_environment.conf')

    configparser = TestResultLogConfigParser(testplan_conf)
    testplan_component = configparser.get_testopia_config('TestPlanCreation', 'testplan_component')
    #poky_dir = configparser.get_testopia_config('TestPlanCreation', 'poky_dir')
    testcase_dir = configparser.get_testopia_config('TestPlanCreation', 'oeqa_testcase_dir')
    #testcase_dir = os.path.join(poky_dir, testcase_dir)
    print('DEBUG: testcase_dir: %s' % testcase_dir)
    work_dir = configparser.get_testopia_config('TestPlanCreation', 'work_dir')
    print('DEBUG: work_dir: %s' % work_dir)
    git_dir = configparser.get_testopia_config('TestPlanCreation', 'git_dir')
    print('DEBUG: git_dir: %s' % git_dir)
    testplan_cycle = configparser.get_testopia_config('TestPlanCreation', 'testplan_cycle')
    print('DEBUG: testplan_cycle: %s' % testplan_cycle)

    testplan_creator = TestPlanCreator()
    test_env_matrix = testplan_creator.get_test_environment_multiplication_matrix(testplan_component, component_conf, environment_conf)
    print('DEGUG: test_env_matrix:')
    print(test_env_matrix)
    test_moduleclass_function_dict = testplan_creator.get_test_moduleclass_test_function_dictionary(testcase_dir)
    print('DEGUG: test_moduleclass_function_dict:')
    print(test_moduleclass_function_dict)
    test_module_moduleclass_dict = testplan_creator.get_test_module_test_moduleclass_dictionary(test_moduleclass_function_dict)
    print('DEGUG: test_module_moduleclass_dict:')
    print(test_module_moduleclass_dict)

    testplan_git_writer = TestPlanGitWriter()
    #work_dir = os.path.join(scripts_path, 'test-result-new-dir')
    #git_repo = os.path.join(scripts_path, 'test-result--new-git-dir')
    testplan_git_writer.write_testplan_to_storage(test_env_matrix, test_module_moduleclass_dict, test_moduleclass_function_dict, work_dir, testplan_component, git_dir, testplan_cycle)

if __name__ == "__main__":
    sys.exit(main())
